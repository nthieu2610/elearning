<!DOCTYPE html>
<html lang="vi">
	<head>
		<meta charset="UTF-8" />
		<title>ISO</title>
		<style>
			/* Trang trắng, tối giản */
			html,
			body {
				background: #fff;
				color: #111;
				font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
				margin: 0;
			}
			.wrap {
				max-width: 900px;
				margin: 24px auto;
				padding: 0 16px;
			}
			textarea,
			input,
			button {
				font: inherit;
			}
			textarea,
			input {
				width: 100%;
				box-sizing: border-box;
				padding: 10px;
				border: 1px solid #ccc;
				border-radius: 6px;
			}
			textarea {
				min-height: 200px;
			}
			button {
				margin-top: 10px;
				padding: 10px 14px;
				border: 1px solid #ccc;
				border-radius: 6px;
				background: #f7f7f7;
				cursor: pointer;
			}
			.muted {
				color: #666;
			}
		</style>
	</head>
	<body>
		<div class="wrap" id="formContainer">
			<div style="margin-bottom: 8px" class="muted">
				Ctrl+Shift+I > Network > Vào Cuộc thi (chưa bấm bắt đầu làm bài) > Làm theo hướng dẫn và dán
				phần copy trong payload vào ô bên dưới.
			</div>
			<input id="baseUrl" hidden value="https://elearning-api.evn.com.vn/paper/api/load-paper" />
			<textarea id="payload"></textarea>
			<button id="btnSend">Lấy kết quả</button>
			<div>
				<img src="https://i.ibb.co/MDqzm9NF/iso.png" border="0" />
			</div>
			<div id="status" class="muted" style="margin-top: 6px"></div>
		</div>

		<script>
			function parseKeyValuePayload(text) {
				const lines = text.replace(/\r/g, '').split('\n');
				const obj = {};
				let i = 0;
				while (i < lines.length && lines[i].trim() === '') i++;
				while (i < lines.length) {
					const key = (lines[i] || '').trim();
					if (!key) {
						i++;
						continue;
					}
					const val = i + 1 < lines.length ? lines[i + 1] : '';
					obj[key] = val;
					i += 2;
				}
				return obj;
			}

			function escapeHtml(s) {
				return String(s).replace(/[&<>]/g, (c) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;' }[c]));
			}

			document.getElementById('btnSend').onclick = () => {
				const baseUrl = document.getElementById('baseUrl').value.trim();
				const payload = document.getElementById('payload').value;
				const status = document.getElementById('status');
				status.textContent = '';
				if (!baseUrl || !payload) {
					status.textContent = 'Thiếu URL hoặc payload';
					return;
				}

				const form = parseKeyValuePayload(payload);
				const REQUIRED_KEYS = [
					'syllabus_iid',
					'is_testing',
					'exam_order',
					'ciid',
					'submit',
					'_sand_ajax',
					'_sand_platform',
					'_sand_readmin',
					'_sand_is_wan',
					'_sand_token',
					'_sand_uiid',
					'_sand_uid',
				];
				const params = new URLSearchParams();
				REQUIRED_KEYS.forEach((k) => {
					if (Object.prototype.hasOwnProperty.call(form, k))
						params.append(k, String(form[k] ?? ''));
				});
				const qs = params.toString();
				const fullURL = baseUrl + (qs ? '?' + qs : '?');

				if (!qs) {
					status.textContent = 'Không tìm thấy các khóa bắt buộc trong payload.';
					return;
				}

				fetch(fullURL, { method: 'POST' })
					.then((r) => r.json())
					.then((data) => {
						const qs = data?.result?.children?.[0]?.children || [];
						const parts = [];
						for (let i = 0; i < qs.length; i++) {
							const a = Number(qs[i]?.answers);
							parts.push(`${i + 1}:${isFinite(a) ? a + 1 : '?'}`);
						}
						const text = parts.join(' - ') + ' - ';
						const body = `<div style="font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:#111;background:#fff;margin:0;padding:24px">${escapeHtml(
							text
						)}</div>`;
						document.open();
						document.write(`<!doctype html><meta charset="utf-8">${body}`);
						document.close();
					})
					.catch((err) => {
						const body = `<pre style="white-space:pre-wrap;word-break:break-word;font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:#111;background:#fff;margin:0;padding:24px">Lỗi: ${escapeHtml(
							err.message || String(err)
						)}</pre>`;
						document.open();
						document.write(`<!doctype html><meta charset="utf-8">${body}`);
						document.close();
					});
			};
		</script>
	</body>
</html>
